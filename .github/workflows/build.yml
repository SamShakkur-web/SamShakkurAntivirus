name: ğŸ›¡ï¸ Build SamShakkur Antivirus

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    name: ğŸªŸ Build Windows Executable
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: ğŸ—ï¸ Build executable
      run: |
        # CrÃ©er les dossiers s'ils n'existent pas
        if not exist data mkdir data
        if not exist resources mkdir resources
        
        # Compiler avec PyInstaller
        pyinstaller `
          --name="SamShakkurAntivirus" `
          --icon="resources/icon.ico" `
          --add-data="src;src" `
          --add-data="data;data" `
          --add-data="resources;resources" `
          --add-data=".env;." `
          --hidden-import="streamlit" `
          --hidden-import="flask" `
          --hidden-import="stripe" `
          --hidden-import="Crypto" `
          --hidden-import="psutil" `
          --hidden-import="pandas" `
          --hidden-import="numpy" `
          --hidden-import="requests" `
          --hidden-import="python_dotenv" `
          --hidden-import="cachetools" `
          --console `
          --onefile `
          --clean `
          main.py
          
    - name: ğŸ“¦ Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: SamShakkurAntivirus-Windows
        path: dist/SamShakkurAntivirus.exe
        
  build-linux:
    name: ğŸ§ Build Linux Executable
    runs-on: ubuntu-latest
    needs: build-windows
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: ğŸ—ï¸ Build Linux executable
      run: |
        pyinstaller \
          --name="SamShakkurAntivirus" \
          --add-data="src:src" \
          --add-data="data:data" \
          --add-data="resources:resources" \
          --add-data=".env:." \
          --hidden-import="streamlit" \
          --hidden-import="flask" \
          --hidden-import="stripe" \
          --hidden-import="Crypto" \
          --hidden-import="psutil" \
          --hidden-import="pandas" \
          --hidden-import="numpy" \
          --hidden-import="requests" \
          --hidden-import="python_dotenv" \
          --hidden-import="cachetools" \
          --console \
          --onefile \
          main.py
          
    - name: ğŸ“¦ Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: SamShakkurAntivirus-Linux
        path: dist/SamShakkurAntivirus
        
  create-release:
    name: ğŸš€ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux]
    if: success()
    
    steps:
    - name: ğŸ“¥ Download artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        
    - name: ğŸ·ï¸ Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/SamShakkurAntivirus-Windows/SamShakkurAntivirus.exe
          artifacts/SamShakkurAntivirus-Linux/SamShakkurAntivirus
        tag_name: v2.0.0-${{ github.run_number }}
        name: SamShakkur Antivirus v2.0.0 (Build #${{ github.run_number }})
        body: |
          ğŸ›¡ï¸ SamShakkur Antivirus - Version ${{ github.run_number }}
          
          ### ğŸ“¦ TÃ©lÃ©chargements :
          - **Windows** : SamShakkurAntivirus.exe
          - **Linux** : SamShakkurAntivirus
          
          ### ğŸš€ Instructions :
          1. TÃ©lÃ©chargez la version correspondante
          2. ExÃ©cutez l'application
          3. Connectez-vous avec votre email
        draft: false
        prerelease: false
