name: ğŸ›¡ï¸ Build SamShakkur Antivirus

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    name: ğŸªŸ Build Windows
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” VÃ©rifier la structure
      run: |
        echo "Structure des fichiers :"
        dir /b
        echo "Src :"
        dir /b src
        echo "Data :"
        if exist data dir /b data
        echo "Resources :"
        if exist resources dir /b resources
        
    - name: ğŸ“¦ CrÃ©er fichiers manquants
      run: |
        # CrÃ©er les dossiers nÃ©cessaires
        if not exist data mkdir data
        if not exist resources mkdir resources
        
        # CrÃ©er users.db s'il n'existe pas
        if not exist data/users.db (
          python -c "import sqlite3; conn = sqlite3.connect('data/users.db'); conn.close(); print('âœ… Database created')"
        )
        
        # CrÃ©er icon.ico s'il n'existe pas
        if not exist resources/icon.ico (
          python -c "
try:
    from PIL import Image, ImageDraw
    img = Image.new('RGB', (256, 256), '#3498db')
    draw = ImageDraw.Draw(img)
    draw.rectangle([64, 64, 192, 192], fill='#FFA500')
    draw.ellipse([80, 80, 176, 176], fill='#FFFFFF')
    img.save('resources/icon.ico', format='ICO')
    print('âœ… Icon created')
except Exception as e:
    print('âš ï¸ Could not create icon:', e)
"
        )
        
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install streamlit==1.28.0
        pip install flask==2.3.3
        pip install stripe==5.5.0
        pip install pycryptodome==3.19.0
        pip install psutil==5.9.5
        pip install pandas==2.0.3
        pip install numpy==1.24.3
        pip install requests==2.31.0
        pip install python-dotenv==1.0.0
        pip install cachetools==5.3.1
        pip install Pillow==10.0.0
        pip install pyinstaller==5.13.0
        
    - name: ğŸ—ï¸ Build executable
      run: |
        echo "ğŸ”¨ Building executable..."
        pyinstaller `
          --name="SamShakkurAntivirus" `
          --icon="resources/icon.ico" `
          --add-data="src;src" `
          --add-data="data;data" `
          --add-data="resources;resources" `
          --add-data=".env;." `
          --hidden-import="streamlit" `
          --hidden-import="flask" `
          --hidden-import="stripe" `
          --hidden-import="Crypto" `
          --hidden-import="psutil" `
          --hidden-import="pandas" `
          --hidden-import="numpy" `
          --hidden-import="requests" `
          --hidden-import="python_dotenv" `
          --hidden-import="cachetools" `
          --console `
          --onefile `
          main.py
          
        echo "âœ… Build completed!"
        
    - name: ğŸ“¦ Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: SamShakkurAntivirus-Windows
        path: dist/SamShakkurAntivirus.exe
        
  create-release:
    name: ğŸš€ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux]
    if: success()
    
    steps:
    - name: ğŸ“¥ Download artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        
    - name: ğŸ·ï¸ Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/SamShakkurAntivirus-Windows/SamShakkurAntivirus.exe
          artifacts/SamShakkurAntivirus-Linux/SamShakkurAntivirus
        tag_name: v2.0.0-${{ github.run_number }}
        name: SamShakkur Antivirus v2.0.0 (Build #${{ github.run_number }})
        body: |
          ğŸ›¡ï¸ SamShakkur Antivirus - Version ${{ github.run_number }}
          
          ### ğŸ“¦ TÃ©lÃ©chargements :
          - **Windows** : SamShakkurAntivirus.exe
          - **Linux** : SamShakkurAntivirus
          
          ### ğŸš€ Instructions :
          1. TÃ©lÃ©chargez la version correspondante
          2. ExÃ©cutez l'application
          3. Connectez-vous avec votre email
        draft: false
        prerelease: false
